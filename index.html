<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>G√©n√©rateur de Fiches Produits</title>
  
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    :root {
      --color-primary: #2ecc71;
      --color-secondary: #27ae60;
      --color-accent: #f39c12;
      --color-bg: #ecf0f1;
      --color-text: #2c3e50;
      --color-white: #ffffff;
      --shadow: 0 10px 40px rgba(0,0,0,0.1);
    }

    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }

    .container {
      background: var(--color-white);
      border-radius: 20px;
      box-shadow: var(--shadow);
      padding: 60px 40px;
      max-width: 500px;
      width: 100%;
      text-align: center;
      animation: fadeIn 0.6s ease;
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(-20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .logo {
      font-size: 4rem;
      margin-bottom: 20px;
      animation: bounce 2s infinite;
    }

    @keyframes bounce {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(-10px); }
    }

    h1 {
      font-size: 2rem;
      color: var(--color-text);
      margin-bottom: 10px;
      font-weight: 700;
    }

    .subtitle {
      font-size: 1rem;
      color: #7f8c8d;
      margin-bottom: 40px;
    }

    .form-group {
      margin-bottom: 30px;
      text-align: left;
    }

    label {
      display: block;
      font-weight: 600;
      color: var(--color-text);
      margin-bottom: 10px;
      font-size: 0.95rem;
    }

    input[type="text"] {
      width: 100%;
      padding: 16px 20px;
      font-size: 1.1rem;
      border: 2px solid #e0e0e0;
      border-radius: 12px;
      transition: all 0.3s ease;
      font-family: inherit;
    }

    input[type="text"]:focus {
      outline: none;
      border-color: var(--color-primary);
      box-shadow: 0 0 0 4px rgba(46, 204, 113, 0.1);
    }

    .btn {
      width: 100%;
      padding: 18px;
      font-size: 1.1rem;
      font-weight: 600;
      border: none;
      border-radius: 12px;
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      font-family: inherit;
    }

    .btn-primary {
      background: linear-gradient(135deg, var(--color-primary) 0%, var(--color-secondary) 100%);
      color: var(--color-white);
      box-shadow: 0 4px 15px rgba(46, 204, 113, 0.3);
    }

    .btn-primary:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(46, 204, 113, 0.4);
    }

    .btn-primary:active:not(:disabled) {
      transform: translateY(0);
    }

    .btn-primary:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }

    .examples {
      margin-top: 30px;
      padding-top: 30px;
      border-top: 1px solid #e0e0e0;
    }

    .examples-title {
      font-size: 0.9rem;
      color: #7f8c8d;
      margin-bottom: 15px;
    }

    .examples-list {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      justify-content: center;
    }

    .example-tag {
      padding: 8px 16px;
      background: #f8f9fa;
      border: 1px solid #e0e0e0;
      border-radius: 20px;
      font-size: 0.9rem;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .example-tag:hover {
      background: var(--color-primary);
      color: var(--color-white);
      border-color: var(--color-primary);
      transform: scale(1.05);
    }

    /* Loader */
    .loader {
      display: none;
      margin-top: 20px;
    }

    .loader.active {
      display: block;
    }

    .spinner {
      width: 50px;
      height: 50px;
      margin: 0 auto 15px;
      border: 4px solid #f3f3f3;
      border-top: 4px solid var(--color-primary);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .loader-text {
      color: #7f8c8d;
      font-size: 0.95rem;
    }

    .error {
      background: #fee;
      border: 1px solid #fcc;
      color: #c33;
      padding: 15px;
      border-radius: 8px;
      margin-top: 20px;
      display: none;
    }

    .error.active {
      display: block;
      animation: shake 0.5s ease;
    }

    @keyframes shake {
      0%, 100% { transform: translateX(0); }
      25% { transform: translateX(-10px); }
      75% { transform: translateX(10px); }
    }

    @media (max-width: 600px) {
      .container {
        padding: 40px 25px;
      }

      h1 {
        font-size: 1.5rem;
      }

      .logo {
        font-size: 3rem;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="logo">üçá</div>
    <h1>G√©n√©rateur de Fiches Produits</h1>
    <p class="subtitle">Cr√©ez une fiche PDF en quelques secondes</p>

    <form id="productForm">
      <div class="form-group">
        <label for="productName">Quel produit souhaitez-vous ?</label>
        <input 
          type="text" 
          id="productName" 
          name="productName"
          placeholder="Ex: Mangue, Avocat, Litchi..."
          autocomplete="off"
          required
          autofocus
        >
      </div>

      <button type="submit" class="btn btn-primary" id="submitBtn">
        <span>‚ú®</span>
        <span>G√©n√©rer ma fiche</span>
      </button>
    </form>

    <!-- Loader -->
    <div class="loader" id="loader">
      <div class="spinner"></div>
      <p class="loader-text" id="loaderText">G√©n√©ration en cours...</p>
    </div>

    <!-- Message d'erreur -->
    <div class="error" id="error"></div>

    <!-- Exemples -->
    <div class="examples">
      <p class="examples-title">üí° Exemples populaires</p>
      <div class="examples-list">
        <span class="example-tag" data-product="Mangue">ü•≠ Mangue</span>
        <span class="example-tag" data-product="Avocat">ü•ë Avocat</span>
        <span class="example-tag" data-product="Litchi">üçí Litchi</span>
        <span class="example-tag" data-product="Fruit de la passion">üåü Fruit de la passion</span>
        <span class="example-tag" data-product="Papaye">üß° Papaye</span>
        <span class="example-tag" data-product="Kiwi">ü•ù Kiwi</span>
      </div>
    </div>
  </div>

  <script>
    // ========================================
    // CONFIGURATION
    // ========================================
    const CONFIG = {
      // üî• REMPLACEZ PAR VOTRE URL WEBHOOK N8N
      N8N_WEBHOOK_URL: 'https://votre-n8n.com/webhook/generate-product-sheet',
      TIMEOUT: 30000 // 30 secondes
    };

    // ========================================
    // √âL√âMENTS DOM
    // ========================================
    const form = document.getElementById('productForm');
    const input = document.getElementById('productName');
    const submitBtn = document.getElementById('submitBtn');
    const loader = document.getElementById('loader');
    const loaderText = document.getElementById('loaderText');
    const errorDiv = document.getElementById('error');

    // ========================================
    // INITIALISATION
    // ========================================
    document.addEventListener('DOMContentLoaded', () => {
      setupEventListeners();
      checkUrlParams();
    });

    function setupEventListeners() {
      // Soumission du formulaire
      form.addEventListener('submit', handleSubmit);

      // Exemples cliquables
      document.querySelectorAll('.example-tag').forEach(tag => {
        tag.addEventListener('click', () => {
          input.value = tag.dataset.product;
          input.focus();
        });
      });

      // Effacer l'erreur quand on tape
      input.addEventListener('input', () => {
        hideError();
      });
    }

    // V√©rifier si retour depuis preview.html
    function checkUrlParams() {
      const params = new URLSearchParams(window.location.search);
      if (params.get('return') === 'true') {
        const product = params.get('product');
        if (product) {
          input.value = decodeURIComponent(product);
        }
      }
    }

    // ========================================
    // SOUMISSION
    // ========================================
    async function handleSubmit(e) {
      e.preventDefault();
      
      const productName = input.value.trim();
      
      if (!productName) {
        showError('Veuillez entrer un nom de produit');
        return;
      }

      // Validation
      if (!/^[a-zA-Z√Ä-√ø\s'-]+$/.test(productName)) {
        showError('Le nom du produit contient des caract√®res invalides');
        return;
      }

      await generateAndRedirect(productName);
    }

    // ========================================
    // G√âN√âRATION ET REDIRECTION
    // ========================================
    async function generateAndRedirect(productName) {
      try {
        showLoader('Connexion au serveur...');
        disableForm();

        // Appel API
        const data = await callN8nWebhook(productName);

        if (!data.success) {
          throw new Error(data.error || 'Erreur inconnue');
        }

        showLoader('‚úÖ Fiche g√©n√©r√©e ! Redirection...');

        // Stocker les donn√©es dans sessionStorage
        sessionStorage.setItem('pdfContent', JSON.stringify(data.pdfContent));
        sessionStorage.setItem('productName', productName);

        // Redirection vers preview.html
        setTimeout(() => {
          window.location.href = 'preview.html';
        }, 500);

      } catch (error) {
        console.error('‚ùå Erreur:', error);
        showError(error.message);
        enableForm();
        hideLoader();
      }
    }

    // ========================================
    // APPEL WEBHOOK N8N
    // ========================================
    async function callN8nWebhook(productName) {
      showLoader('G√©n√©ration par l\'IA...');

      const controller = new AbortController();
      const timeoutId = setTimeout(() => controller.abort(), CONFIG.TIMEOUT);

      try {
        const response = await fetch(CONFIG.N8N_WEBHOOK_URL, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            productName: productName
          }),
          signal: controller.signal
        });

        clearTimeout(timeoutId);

        if (!response.ok) {
          const error = await response.json().catch(() => ({}));
          throw new Error(error.error || `Erreur HTTP ${response.status}`);
        }

        const data = await response.json();

        showLoader('Pr√©paration de l\'aper√ßu...');

        return data;

      } catch (error) {
        clearTimeout(timeoutId);

        if (error.name === 'AbortError') {
          throw new Error('Timeout : le serveur ne r√©pond pas');
        }

        throw error;
      }
    }

    // ========================================
    // UTILITAIRES UI
    // ========================================
    function showLoader(text) {
      loader.classList.add('active');
      loaderText.textContent = text;
    }

    function hideLoader() {
      loader.classList.remove('active');
    }

    function showError(message) {
      errorDiv.textContent = '‚ùå ' + message;
      errorDiv.classList.add('active');
    }

    function hideError() {
      errorDiv.classList.remove('active');
    }

    function disableForm() {
      submitBtn.disabled = true;
      input.disabled = true;
    }

    function enableForm() {
      submitBtn.disabled = false;
      input.disabled = false;
      input.focus();
    }
  </script>
</body>
</html>
